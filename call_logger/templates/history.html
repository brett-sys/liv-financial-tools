{% extends "base.html" %}
{% block title %}Call History - Call Logger{% endblock %}

{% block content %}
<div class="history-page">
    <div class="dash-header">
        <h1>Call History</h1>
        <a href="{{ url_for('log_call') }}" class="btn btn-primary">+ Log Call</a>
    </div>

    <!-- Filters -->
    <form method="GET" action="{{ url_for('history') }}" class="filter-bar card">
        <div class="filter-row">
            <input type="text" name="search" placeholder="Search name or number..."
                   value="{{ filters.search }}" class="filter-input">
            <select name="agent_name" class="filter-select">
                <option value="">All Agents</option>
                {% for a in agents %}
                <option value="{{ a }}" {% if filters.agent_name == a %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
            <select name="direction" class="filter-select">
                <option value="">All Directions</option>
                {% for d in directions %}
                <option value="{{ d }}" {% if filters.direction == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
            <select name="outcome" class="filter-select">
                <option value="">All Outcomes</option>
                {% for o in outcomes %}
                <option value="{{ o }}" {% if filters.outcome == o %}selected{% endif %}>{{ o }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-row">
            <input type="date" name="date_from" value="{{ filters.date_from }}" class="filter-input" placeholder="From">
            <input type="date" name="date_to" value="{{ filters.date_to }}" class="filter-input" placeholder="To">
            <button type="submit" class="btn btn-secondary">Filter</button>
            <a href="{{ url_for('history') }}" class="btn btn-ghost">Clear</a>
        </div>
    </form>

    <!-- Results -->
    {% if calls %}
    <div class="call-list">
        {% for call in calls %}
        <div class="call-card">
            <div class="call-card-header">
                <div class="call-meta">
                    <span class="badge badge-{{ call.direction | lower }}">
                        {% if call.direction == 'Outbound' %}&#x2197;{% else %}&#x2199;{% endif %}
                        {{ call.direction }}
                    </span>
                    <span class="badge badge-outcome badge-{{ call.outcome | lower | replace(' ', '-') }}">
                        {{ call.outcome }}
                    </span>
                </div>
                <div class="call-date">{{ call.call_datetime[:16] }}</div>
            </div>
            <div class="call-card-body">
                {% if call.agent_name %}
                <div class="call-agent">Agent: {{ call.agent_name }}</div>
                {% endif %}
                <div class="call-contact">
                    <strong>{{ call.contact_name or 'Unknown' }}</strong>
                    {% if call.phone_number %}<span class="call-phone">{{ call.phone_number }}</span>{% endif %}
                </div>
                {% if call.notes %}
                <p class="call-notes">{{ call.notes }}</p>
                {% endif %}
                {% if call.follow_up_date %}
                <div class="call-followup">Follow-up: {{ call.follow_up_date }}</div>
                {% endif %}
            </div>
            <div class="call-card-actions">
                <a href="{{ url_for('edit_call', call_id=call.id) }}" class="btn btn-sm btn-secondary">Edit</a>
                <form method="POST" action="{{ url_for('delete_call', call_id=call.id) }}" class="inline-form"
                      onsubmit="return confirm('Delete this call?')">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>No calls found.</p>
        <a href="{{ url_for('log_call') }}" class="btn btn-primary">Log your first call</a>
    </div>
    {% endif %}
</div>
{% endblock %}
